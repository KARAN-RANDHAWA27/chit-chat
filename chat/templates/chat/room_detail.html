{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="flex h-screen bg-gray-100 overflow-hidden">
  <!-- Sidebar with condensed chat list -->
  <div id="chat-list" class="w-80 bg-white border-r border-gray-300 flex flex-col overflow-hidden md:block hidden">
    <div class="p-4 border-b border-gray-300">
      <h2 class="text-xl font-semibold">Chats</h2>
    </div>
    <div class="flex-1 overflow-y-auto">
      {% for chat_item in chats %}
        <a href="{% url 'chat:room_detail' chat_item.id %}" class="block chat-item" data-chat-id="{{ chat_item.id }}">
          <div class="p-3 hover:bg-gray-100 cursor-pointer {% if chat_item.id == chat.id %}bg-blue-100{% endif %}">
            <div class="flex items-center">
              {% if chat_item.is_group_chat %}
                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold mr-3">
                  {{ chat_item.name|slice:":2" }}
                </div>
              {% else %}
              <img src="{% if chat_item.other_participant.profile_picture %}{{ chat_item.other_participant.avatar.url }}{% else %}{% static 'images/profile.png' %}{% endif %}" alt="{{ chat_item.name }}" class="w-10 h-10 rounded-full mr-3">
              {% endif %}
              <div class="flex-1 min-w-0">
                <h3 class="text-sm font-semibold text-gray-900 truncate">{{ chat_item.name }}</h3>
                <p class="text-xs text-gray-600 truncate last-message">
                  {% if chat_item.last_message %}
                    {{ chat_item.last_message.content }}
                  {% else %}
                    No messages yet
                  {% endif %}
                </p>
                <p class="text-xs text-gray-500 last-message-time">
                  {% if chat_item.last_message %}
                    {{ chat_item.last_message.timestamp|date:"H:i" }}
                  {% endif %}
                </p>
              </div>
            </div>
          </div>
        </a>
      {% endfor %}
    </div>
  </div>

  <!-- Main Chat Area -->
  <div id="chat-area" class="flex-1 flex flex-col bg-white overflow-hidden">
    <!-- Chat Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-300">
      <!-- Back button for small screens -->
      <button id="back-button" class="md:hidden block p-2">
        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>
      <div class="flex items-center">
        {% if chat.is_group_chat %}
          <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold mr-3">{{ chat_name|slice:":2" }}</div>
        {% else %}
          <img src="{% if other_participant.profile_picture %}{{ other_participant.profile_picture.url }}{% else %}{% static 'images/profile.png' %}{% endif %}" alt="{{ profile }}" class="w-10 h-10 rounded-full mr-3">
        {% endif %}
        <div>
          <h2 class="text-xl font-semibold">{{ chat_name }}</h2>
          <p class="text-sm text-gray-500">{{ other_participant.email }}</p>
        </div>
      </div>
    </div>

    <!-- Chat Messages -->
    <div class="flex-1 overflow-y-auto p-4" id="chat-messages">
      {% for message in messages %}
        <div class="flex {% if message.sender == request.user %}justify-end{% endif %} mb-4">
          <div class="{% if message.sender == request.user %}bg-blue-500 text-white{% else %}bg-gray-200 text-gray-800{% endif %} rounded-lg py-2 px-4 max-w-xs lg:max-w-md">
            {% if chat.is_group_chat and message.sender != request.user %}
              <p class="text-xs font-bold {% if message.sender == request.user %}text-blue-200{% else %}text-gray-600{% endif %} mb-1">{{ message.sender.get_full_name|default:"Chit Chat User" }}</p>
            {% endif %}
            <p>{{ message.content }}</p>
            <p class="text-xs text-right mt-1 {% if message.sender == request.user %}text-blue-200{% else %}text-gray-500{% endif %}">{{ message.timestamp|date:"H:i" }}</p>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Message Input -->
    <div class="border-t border-gray-300 p-4">
      <form id="chat-form" class="flex items-center">
        <input type="text" id="chat-message-input" class="flex-1 border border-gray-300 rounded-full py-2 px-4 mr-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type a message..." />
        <button type="submit" class="bg-blue-500 text-white rounded-full p-3 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
          </svg>
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  const chatSocket = new WebSocket(
    'ws://' + window.location.host +
    '/ws/chat/{{ chat.id }}/'
  );

  const userSocket = new WebSocket(
    'ws://' + window.location.host +
    '/ws/user/{{ request.user.id }}/'
  );

  const chatMessages = document.getElementById('chat-messages');
  const chatList = document.getElementById('chat-list');

  function formatTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Asia/Kolkata' });
  }

  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    if (data.type === 'chat_message') {
      const isCurrentUser = data.user_id == {{ request.user.id }};
      const isGroupChat = {{ chat.is_group_chat|yesno:"true,false" }};
      const formattedTime = formatTime(data.timestamp);
      const messageHtml = `
        <div class="flex ${ isCurrentUser ? 'justify-end' : '' } mb-4">
          <div class="${ isCurrentUser ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800' } rounded-lg py-2 px-4 max-w-xs lg:max-w-md">
            ${ isGroupChat && !isCurrentUser ? `<p class="text-xs font-bold ${ isCurrentUser ? 'text-blue-200' : 'text-gray-600' } mb-1">${data.username}</p>` : '' }
            <p>${data.message}</p>
            <p class="text-xs text-right mt-1 ${ isCurrentUser ? 'text-blue-200' : 'text-gray-500' }">${formattedTime}</p>
          </div>
        </div>
      `;
      chatMessages.insertAdjacentHTML('beforeend', messageHtml);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  };

  userSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    if (data.type === 'update_chat_list') {
      updateChatList(data);
    }
  };

  function updateChatList(data) {
    const chatItem = document.querySelector(`[data-chat-id="${data.chat_id}"]`);
    if (chatItem) {
      const lastMessageElement = chatItem.querySelector('.last-message');
      const lastMessageTimeElement = chatItem.querySelector('.last-message-time');
      
      if (lastMessageElement) {
        lastMessageElement.textContent = data.last_message;
      }
      
      if (lastMessageTimeElement) {
        lastMessageTimeElement.textContent = formatTime(data.last_message_time);
      }
      
      // Move the updated chat to the top of the list
      chatList.prepend(chatItem.closest('a'));
    }
  }

  // Handle form submission to send a new message
  document.getElementById('chat-form').onsubmit = function(e) {
    e.preventDefault();
    const messageInput = document.getElementById('chat-message-input');
    const message = messageInput.value.trim();
    if (message) {
      chatSocket.send(JSON.stringify({
        'message': message,
        'user_id': {{ request.user.id }}
      }));
      messageInput.value = '';
    }
  };

  // Handle back button click to show the chat list
  document.getElementById('back-button').onclick = function() {
    document.getElementById('chat-list').classList.remove('hidden');
    document.getElementById('chat-area').classList.add('hidden');
  };

  // Handle chat item click to show the chat area
  document.querySelectorAll('.chat-item').forEach(item => {
    item.onclick = function(e) {
      e.preventDefault();
      document.getElementById('chat-list').classList.add('hidden');
      document.getElementById('chat-area').classList.remove('hidden');
      window.location.href = item.href; // Navigate to the selected chat
    };
  });
</script>
{% endblock %}

